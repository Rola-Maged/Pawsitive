import chalk from 'chalk';

import {
  validateConfiguration,
  deleteArchive,
  loadConfiguration,
  createArchive,
  getConfigurationFilePath,
} from '../utils/index.js';
import ApiClient from '../api.js';

export type DeployCommandArgs = {
  apiKey: string;
  apiSecret: string;
  config?: string;
};

const deploy = async (opts: DeployCommandArgs): Promise<void> => {
  const { apiKey, apiSecret, config } = opts;

  const configuration = loadConfiguration(getConfigurationFilePath(config));

  if (!validateConfiguration(configuration)) {
    return process.exit(1);
  }

  /* eslint-disable max-len */
  console.log(`
    ${chalk.yellow('Please use AdminJS Cloud Dashboard to set your environment variables.')}\n\n
    ${chalk.blueBright('https://docs.adminjs.co/deployment/editing-environment-variables')}\n\n
    ${chalk.red('Do not include .env file if it contains confidential data.')}
  `);
  /* eslint-enable max-len */

  const { file, fileName, filePath } = await createArchive(configuration);

  console.log(chalk.blueBright('Uploading the package...'));

  const api = ApiClient({ apiKey, apiSecret });
  await api.deploy({ file, filePath, fileName });

  await deleteArchive(filePath);
};

export default deploy;
